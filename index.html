<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Android AR - 方向確認</title>

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: monospace; }
        
        /* 画面上部のデバッグ表示（ここで動作状況を確認します） */
        #debug-console {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            background: rgba(0,0,0,0.6); 
            color: #00ff00; 
            padding: 10px; 
            pointer-events: none; 
            z-index: 999;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
        }
    </style>

    <script>
        // 画面にログを出す関数
        function debugLog(msg) {
            const el = document.getElementById('debug-console');
            if(el) el.innerHTML = msg; // 常に最新の状態だけ表示
        }

        AFRAME.registerComponent('fixed-bearing', {
            schema: {
                latitude: { type: 'number', default: 0 },
                longitude: { type: 'number', default: 0 },
                distance: { type: 'number', default: 5 }, // 5メートル先に固定
                name: { type: 'string', default: '' }
            },
            init: function () {
                this.placed = false;

                // GPS更新イベント
                window.addEventListener('gps-camera-update-position', (e) => {
                    // 一度配置したら固定する（チラつき防止）
                    if(this.placed) return;

                    const userPos = e.detail.position;
                    
                    // 1. 方位角(Bearing)を計算
                    const bearing = this.calculateBearing(
                        userPos.latitude, userPos.longitude,
                        this.data.latitude, this.data.longitude
                    );

                    // 2. その方角の座標を計算 (北 = -Z)
                    const theta = bearing * (Math.PI / 180);
                    const x = this.data.distance * Math.sin(theta);
                    const z = -1 * this.data.distance * Math.cos(theta);

                    // 3. 配置
                    this.el.setAttribute('position', { x: x, y: 1.5, z: z });
                    this.el.setAttribute('visible', true);
                    
                    this.placed = true;
                    console.log(`[${this.data.name}] Placed at bearing: ${Math.round(bearing)}deg`);
                });
            },

            // 方位角計算ロジック
            calculateBearing: function (startLat, startLng, destLat, destLng) {
                const y = Math.sin(destLng * Math.PI / 180 - startLng * Math.PI / 180) * Math.cos(destLat * Math.PI / 180);
                const x = Math.cos(startLat * Math.PI / 180) * Math.sin(destLat * Math.PI / 180) -
                        Math.sin(startLat * Math.PI / 180) * Math.cos(destLat * Math.PI / 180) * Math.cos(destLng * Math.PI / 180 - startLng * Math.PI / 180);
                const brng = Math.atan2(y, x) * 180 / Math.PI;
                return (brng + 360) % 360;
            }
        });

        // 常に画面にGPSの状態を表示するループ
        AFRAME.registerComponent('gps-debugger', {
            tick: function() {
                const cam = this.el.components['gps-camera'];
                if(!cam) return;
                
                // カメラの回転（コンパス方位）を取得
                // Y回転が方位にあたります
                const rot = this.el.getAttribute('rotation');
                const compass = rot.y ? rot.y.toFixed(0) : '---';

                debugLog(`★システム稼働中\nコンパス方位: ${compass}°\n(スマホを回して数値が変わるか確認)`);
            }
        });
    </script>
</head>

<body>
    <div id="debug-console">初期化中...<br>GPSを取得しています</div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false;'
        renderer="antialias: true; alpha: true;">

        <a-camera gps-camera="gpsMinDistance: 5" rotation-reader gps-debugger></a-camera>

        <a-entity position="0 0 -5" look-at="[gps-camera]">
            <a-box color="red" scale="0.5 0.5 0.5"></a-box>
            <a-text value="NORTH" color="red" align="center" position="0 1 0" scale="2 2 2"></a-text>
        </a-entity>


        <a-entity fixed-bearing="latitude: 35.3606; longitude: 138.7274; distance: 5; name: Fuji" visible="false">
            
            <a-entity gltf-model="url(./assets/fuji.glb)" scale="1 1 1" look-at="[gps-camera]"></a-entity>
            
            <a-cone color="cyan" radius-bottom="0.5" radius-top="0" height="1" position="0 -1 0" opacity="0.8"></a-cone>
            <a-text value="Mt. FUJI" color="cyan" align="center" position="0 2 0" scale="2 2 2" look-at="[gps-camera]"></a-text>

        </a-entity>


        <a-entity fixed-bearing="latitude: 34.6851; longitude: 135.8398; distance: 5; name: Ranjatai" visible="false">
            
            <a-entity gltf-model="url(./assets/ra.glb)" scale="1 1 1" look-at="[gps-camera]"></a-entity>
            
            <a-sphere color="yellow" radius="0.3" position="0 -1 0" opacity="0.8"></a-sphere>
            <a-text value="NARA" color="yellow" align="center" position="0 2 0" scale="2 2 2" look-at="[gps-camera]"></a-text>

        </a-entity>

    </a-scene>
</body>
</html>