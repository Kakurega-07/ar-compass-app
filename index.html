<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>方位固定AR</title>

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>

    <script>
        // ==============================================================
        // カスタムコンポーネント: 
        // 指定した緯度経度の方角を計算し、
        // 「固定された距離（目の前）」にオブジェクトを配置する
        // ==============================================================
        AFRAME.registerComponent('fixed-bearing', {
            schema: {
                latitude: { type: 'number', default: 0 },
                longitude: { type: 'number', default: 0 },
                distance: { type: 'number', default: 5 } // カメラからの距離(メートル)
            },
            init: function () {
                this.loaded = false;
                
                // GPS更新イベントを監視
                window.addEventListener('gps-camera-update-position', (e) => {
                    // 一度配置したら動かさない（チラつき防止）
                    if(this.loaded) return;

                    const userPos = e.detail.position;
                    
                    // 1. 自分と目的地の方角(bearing)を計算
                    const angleDeg = this.calculateBearing(
                        userPos.latitude, userPos.longitude,
                        this.data.latitude, this.data.longitude
                    );

                    // 2. その方角の「distanceメートル先」の座標(x, z)を計算
                    // A-Frameでは 北=-Z, 東=X, 南=Z, 西=-X
                    // 角度は北(0)から時計回り
                    const angleRad = angleDeg * (Math.PI / 180);
                    
                    // 方角に基づいて位置を決定 (三角関数)
                    const x = this.data.distance * Math.sin(angleRad);
                    const z = -1 * this.data.distance * Math.cos(angleRad); // 北がマイナスZなので -1

                    // 3. 座標をセット
                    this.el.setAttribute('position', { x: x, y: 1.5, z: z }); // y:1.5は目の高さ
                    
                    // 4. 自分の方を向かせる
                    this.el.setAttribute('look-at', '[gps-camera]');
                    
                    // 5. 表示をオンにする
                    this.el.setAttribute('visible', 'true');

                    // デバッグ用ログ
                    const status = document.getElementById('status');
                    if(status) status.innerText = `方角計算完了: ${angleDeg.toFixed(0)}度 (距離${this.data.distance}m)`;

                    this.loaded = true;
                });
            },

            // 方位角の計算ロジック
            calculateBearing: function (startLat, startLng, destLat, destLng) {
                const y = Math.sin(destLng * Math.PI / 180 - startLng * Math.PI / 180) * Math.cos(destLat * Math.PI / 180);
                const x = Math.cos(startLat * Math.PI / 180) * Math.sin(destLat * Math.PI / 180) -
                        Math.sin(startLat * Math.PI / 180) * Math.cos(destLat * Math.PI / 180) * Math.cos(destLng * Math.PI / 180 - startLng * Math.PI / 180);
                const brng = Math.atan2(y, x) * 180 / Math.PI;
                return (brng + 360) % 360;
            }
        });
    </script>

    <style>
        body { margin: 0; overflow: hidden; }
        #status {
            position: absolute; top: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.6); color: white;
            padding: 10px; text-align: center; font-family: sans-serif; z-index: 99;
        }
    </style>
</head>

<body>
    <div id="status">GPS待機中...<br>スマホを持って少し動いてください</div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false;'
        renderer="antialias: true; alpha: true;">

        <a-camera gps-camera="gpsMinDistance: 5" rotation-reader></a-camera>

        <a-entity
            fixed-bearing="latitude: 35.3606; longitude: 138.7274; distance: 5"
            visible="false">
            <a-entity gltf-model="url(./assets/fuji.glb)" scale="1 1 1"></a-entity>
        </a-entity>
        <a-entity
            fixed-bearing="latitude: 34.6851; longitude: 135.8398; distance: 5"
            visible="false">
            <a-entity gltf-model="url(./assets/ra.glb)" scale="1 1 1"></a-entity>
        </a-entity>

    </a-scene>
</body>
</html>