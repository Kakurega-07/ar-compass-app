<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Location-Based AR Demo</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    #start-button {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    
    #start-button:hover {
      transform: translate(-50%, -50%) scale(1.05);
      box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    }
    
    #info-panel {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 15px;
      border-radius: 10px;
      font-size: 12px;
      max-width: 300px;
      z-index: 1000;
      display: none;
    }
    
    #info-panel.show {
      display: block;
    }
    
    .info-item {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <!-- iOS 13+のためのDeviceOrientation許可リクエストボタン -->
  <button id="start-button">Start AR</button>
  
  <!-- デバッグ情報パネル -->
  <div id="info-panel">
    <div class="info-item"><strong>現在地:</strong> <span id="current-pos">取得中...</span></div>
    <div class="info-item"><strong>富士山への方位:</strong> <span id="fuji-bearing">計算中...</span></div>
    <div class="info-item"><strong>正倉院への方位:</strong> <span id="shosoin-bearing">計算中...</span></div>
  </div>

  <!-- A-Frame AR Scene -->
  <a-scene 
    vr-mode-ui="enabled: false" 
    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
    renderer="logarithmicDepthBuffer: true;"
    embedded
    id="ar-scene"
    style="display: none;">
    
    <!-- カメラ設定 -->
    <a-camera gps-camera rotation-reader look-controls-enabled="false"></a-camera>
    
    <!-- 富士山モデル配置用のエンティティ -->
    <a-entity id="fuji-target">
      <!-- .glbモデルが利用可能な場合 -->
      <a-gltf-model src="./assets/fuji.glb" scale="0.5 0.5 0.5" rotation="0 0 0"></a-gltf-model>
      
      <!-- フォールバック: 赤いボックス -->
      <a-box 
        color="red" 
        scale="2 2 2" 
        position="0 0 0"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear">
        <a-text 
          value="富士山" 
          align="center" 
          color="white" 
          scale="3 3 3" 
          position="0 2 0">
        </a-text>
      </a-box>
    </a-entity>
    
    <!-- 蘭奢待(正倉院)モデル配置用のエンティティ -->
    <a-entity id="ranjatai-target">
      <!-- .glbモデルが利用可能な場合 -->
      <a-gltf-model src="./assets/ra.glb" scale="0.5 0.5 0.5" rotation="0 0 0"></a-gltf-model>
      
      <!-- フォールバック: 青いボックス -->
      <a-box 
        color="blue" 
        scale="2 2 2" 
        position="0 0 0"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear">
        <a-text 
          value="蘭奢待" 
          align="center" 
          color="white" 
          scale="3 3 3" 
          position="0 2 0">
        </a-text>
      </a-box>
    </a-entity>
  </a-scene>

  <script>
    // ==========================================
    // ターゲット情報の定数定義
    // （後から変更しやすいように）
    // ==========================================
    const TARGETS = {
      fuji: {
        name: '富士山',
        modelPath: './assets/fuji.glb',
        lat: 35.3606,
        lng: 138.7274,
        entityId: 'fuji-target'
      },
      ranjatai: {
        name: '蘭奢待(正倉院)',
        modelPath: './assets/ra.glb',
        lat: 34.6851,
        lng: 135.8398,
        entityId: 'ranjatai-target'
      }
    };
    
    // オブジェクトを配置する距離（メートル）
    const DISPLAY_DISTANCE = 8;
    
    // ==========================================
    // 方位角計算関数（Haversine formula）
    // ==========================================
    function calculateBearing(lat1, lng1, lat2, lng2) {
      const toRad = (deg) => deg * (Math.PI / 180);
      const toDeg = (rad) => rad * (180 / Math.PI);
      
      const dLng = toRad(lng2 - lng1);
      const lat1Rad = toRad(lat1);
      const lat2Rad = toRad(lat2);
      
      const y = Math.sin(dLng) * Math.cos(lat2Rad);
      const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) -
                Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
      
      let bearing = toDeg(Math.atan2(y, x));
      // 0〜360度に正規化
      bearing = (bearing + 360) % 360;
      
      return bearing;
    }
    
    // ==========================================
    // 方位角から3D座標への変換
    // ==========================================
    function bearingToPosition(bearing, distance) {
      // A-Frameの座標系: Z軸が-方向(奥)が北
      // X軸が右が東、左が西
      // 方位角0度=北、90度=東、180度=南、270度=西
      
      const rad = (bearing) * (Math.PI / 180);
      
      // X座標: 東西方向（東がプラス）
      const x = Math.sin(rad) * distance;
      // Z座標: 南北方向（北がマイナス）
      const z = -Math.cos(rad) * distance;
      
      return { x, z };
    }
    
    // ==========================================
    // エンティティ配置関数
    // ==========================================
    function positionEntity(entityId, bearing) {
      const entity = document.getElementById(entityId);
      if (!entity) return;
      
      const pos = bearingToPosition(bearing, DISPLAY_DISTANCE);
      // Y座標は目線の高さに設定（0メートル = カメラ位置）
      entity.setAttribute('position', `${pos.x} 0 ${pos.z}`);
      
      console.log(`${entityId} positioned at bearing ${bearing.toFixed(1)}°, position: ${pos.x.toFixed(2)}, 0, ${pos.z.toFixed(2)}`);
    }
    
    // ==========================================
    // GPS位置情報取得とAR初期化
    // ==========================================
    function initAR() {
      const infoPanel = document.getElementById('info-panel');
      const currentPosSpan = document.getElementById('current-pos');
      const fujiBearingSpan = document.getElementById('fuji-bearing');
      const shosoninBearingSpan = document.getElementById('shosoin-bearing');
      
      if (!navigator.geolocation) {
        alert('お使いのブラウザは位置情報に対応していません');
        return;
      }
      
      // 位置情報を取得
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;
          
          console.log(`現在地: ${userLat}, ${userLng}`);
          
          // デバッグ情報を更新
          currentPosSpan.textContent = `${userLat.toFixed(4)}, ${userLng.toFixed(4)}`;
          
          // 各ターゲットへの方位角を計算
          const fujiBearing = calculateBearing(userLat, userLng, TARGETS.fuji.lat, TARGETS.fuji.lng);
          const ranjataiBearing = calculateBearing(userLat, userLng, TARGETS.ranjatai.lat, TARGETS.ranjatai.lng);
          
          console.log(`富士山への方位: ${fujiBearing.toFixed(1)}度`);
          console.log(`正倉院への方位: ${ranjataiBearing.toFixed(1)}度`);
          
          // デバッグ情報を更新
          fujiBearingSpan.textContent = `${fujiBearing.toFixed(1)}°`;
          shosoninBearingSpan.textContent = `${ranjataiBearing.toFixed(1)}°`;
          
          // エンティティを配置
          positionEntity(TARGETS.fuji.entityId, fujiBearing);
          positionEntity(TARGETS.ranjatai.entityId, ranjataiBearing);
          
          // 情報パネルを表示
          infoPanel.classList.add('show');
        },
        (error) => {
          console.error('位置情報取得エラー:', error);
          alert(`位置情報の取得に失敗しました: ${error.message}\n設定で位置情報を許可してください。`);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }
    
    // ==========================================
    // iOS 13+ DeviceOrientation許可リクエスト
    // ==========================================
    function requestDeviceOrientation() {
      if (typeof DeviceOrientationEvent !== 'undefined' && 
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        // iOS 13+
        DeviceOrientationEvent.requestPermission()
          .then(permissionState => {
            if (permissionState === 'granted') {
              startARExperience();
            } else {
              alert('デバイスの向きへのアクセスが拒否されました');
            }
          })
          .catch(console.error);
      } else {
        // iOS以外または古いバージョン
        startARExperience();
      }
    }
    
    // ==========================================
    // AR体験開始
    // ==========================================
    function startARExperience() {
      const startButton = document.getElementById('start-button');
      const scene = document.getElementById('ar-scene');
      
      // ボタンを非表示
      startButton.style.display = 'none';
      
      // シーンを表示
      scene.style.display = 'block';
      
      // AR初期化
      initAR();
    }
    
    // ==========================================
    // イベントリスナー
    // ==========================================
    document.getElementById('start-button').addEventListener('click', () => {
      requestDeviceOrientation();
    });
  </script>
</body>
</html>