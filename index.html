<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Based AR - å¯Œå£«å±±ã¨æ­£å€‰é™¢</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/aframe-ar.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: #f0f0f0;
            overflow: hidden;
        }
        #scene-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            z-index: 100;
        }
        .header {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 20px;
            border-radius: 0 0 10px 10px;
            text-align: center;
            pointer-events: auto;
        }
        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        .header p {
            font-size: 12px;
            opacity: 0.8;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            pointer-events: auto;
            margin-bottom: 30px;
        }
        button {
            padding: 12px 24px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        #startBtn {
            background: #4CAF50;
            color: white;
        }
        #startBtn:hover:not(:disabled) {
            background: #45a049;
        }
        #startBtn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .info-panel {
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            max-width: 280px;
            pointer-events: auto;
        }
        .info-panel div {
            margin: 5px 0;
        }
        .target-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: auto;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="scene-container">
        <a-scene
            vr-mode-ui="enabled: false"
            embedded
            arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;"
        >
            <!-- ã‚«ãƒ¡ãƒ© -->
            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

            <!-- å¯Œå£«å±±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ -->
            <a-entity id="fuji-entity" position="0 0 -5">
                <a-model src="./assets/fuji.glb"></a-model>
                <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¢ãƒ‡ãƒ«ãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆã®èµ¤ã„ãƒœãƒƒã‚¯ã‚¹ -->
                <!-- <a-box color="#FF0000" scale="1 1 1"></a-box> -->
            </a-entity>

            <!-- æ­£å€‰é™¢ï¼ˆè˜­å¥¢å¾…ï¼‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ -->
            <a-entity id="ra-entity" position="0 0 -5">
                <a-model src="./assets/ra.glb"></a-model>
                <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¢ãƒ‡ãƒ«ãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆã®é’ã„ãƒœãƒƒã‚¯ã‚¹ -->
                <!-- <a-box color="#0000FF" scale="0.5 0.5 0.5"></a-box> -->
            </a-entity>

            <!-- ãƒ©ã‚¤ãƒˆ -->
            <a-light type="ambient" intensity="1"></a-light>
            <a-light type="directional" intensity="0.5" position="5 10 7"></a-light>
        </a-scene>

        <!-- UI ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div id="ui-overlay">
            <div class="header">
                <h1>ğŸ“ Location Based AR</h1>
                <p>å¯Œå£«å±±ã¨æ­£å€‰é™¢ã‚’æ¢ã—ã¦ã¿ã‚ˆã†</p>
            </div>
            
            <div class="controls">
                <button id="startBtn">ğŸš€ AR ã‚’é–‹å§‹</button>
                <button id="permissionBtn" style="background: #2196F3;">ğŸ“± ä½ç½®æƒ…å ±ãƒ»ãƒ‡ãƒã‚¤ã‚¹å‘ãè¨±å¯</button>
            </div>

            <div class="info-panel">
                <div><strong>ğŸ“¡ GPSæƒ…å ±</strong></div>
                <div id="gps-status">å¾…æ©Ÿä¸­...</div>
                <div id="user-lat">ç·¯åº¦: ---</div>
                <div id="user-lng">çµŒåº¦: ---</div>
                <div style="margin-top: 10px; border-top: 1px solid #00ff00; padding-top: 10px;">
                    <strong>ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ–¹ä½è§’</strong>
                </div>
                <div id="fuji-bearing">å¯Œå£«å±±: è¨ˆç®—ä¸­...</div>
                <div id="ra-bearing">æ­£å€‰é™¢: è¨ˆç®—ä¸­...</div>
                <div id="device-heading">ãƒ‡ãƒã‚¤ã‚¹æ–¹è§’: è¨ˆç®—ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // å®šæ•°å®šç¾©ï¼šã‚¿ãƒ¼ã‚²ãƒƒãƒˆæƒ…å ±
        // ========================================
        const TARGETS = {
            fuji: {
                name: 'å¯Œå£«å±±',
                modelPath: './assets/fuji.glb',
                entityId: 'fuji-entity',
                lat: 35.3606,
                lng: 138.7274,
                distance: 5 // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è¦‹ãˆã‚‹è·é›¢ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
            },
            ra: {
                name: 'æ­£å€‰é™¢ï¼ˆè˜­å¥¢å¾…ï¼‰',
                modelPath: './assets/ra.glb',
                entityId: 'ra-entity',
                lat: 34.6851,
                lng: 135.8398,
                distance: 5 // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è¦‹ãˆã‚‹è·é›¢ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
            }
        };

        // ========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ========================================
        let userLocation = null;
        let deviceHeading = 0;
        let arStarted = false;

        // ========================================
        // Haversineå…¬å¼ï¼š2ã¤ã®åº§æ¨™é–“ã®è·é›¢ã‚’è¨ˆç®—ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
        // ========================================
        function haversineDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // åœ°çƒã®åŠå¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
            const toRad = Math.PI / 180;
            
            const dLat = (lat2 - lat1) * toRad;
            const dLng = (lng2 - lng1) * toRad;
            
            const a = Math.sin(dLat / 2) ** 2 +
                      Math.cos(lat1 * toRad) * Math.cos(lat2 * toRad) * Math.sin(dLng / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            
            return R * c;
        }

        // ========================================
        // æ–¹ä½è§’è¨ˆç®—ï¼šç¾åœ¨åœ°ã‹ã‚‰ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¸ã®æ–¹å‘ã‚’è¨ˆç®—ï¼ˆ0ã€œ360åº¦ï¼‰
        // North = 0Â°, East = 90Â°, South = 180Â°, West = 270Â°
        // ========================================
        function calculateBearing(lat1, lng1, lat2, lng2) {
            const toRad = Math.PI / 180;
            const dLng = (lng2 - lng1) * toRad;
            
            const y = Math.sin(dLng) * Math.cos(lat2 * toRad);
            const x = Math.cos(lat1 * toRad) * Math.sin(lat2 * toRad) -
                      Math.sin(lat1 * toRad) * Math.cos(lat2 * toRad) * Math.cos(dLng);
            
            let bearing = Math.atan2(y, x) * (180 / Math.PI);
            bearing = (bearing + 360) % 360; // 0ã€œ360ã«æ­£è¦åŒ–
            
            return bearing;
        }

        // ========================================
        // æ–¹ä½è§’ã«åŸºã¥ã„ã¦ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ã‚’è¨ˆç®—
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã‚«ãƒ¡ãƒ©ï¼‰ã‚’ä¸­å¿ƒã«ã€æŒ‡å®šæ–¹å‘ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…ç½®
        // ========================================
        function getLocalPositionFromBearing(bearing, distance) {
            const toRad = Math.PI / 180;
            // A-Frameã®åº§æ¨™ç³»ï¼š-Z ãŒå‰æ–¹ã€+Y ãŒä¸Šã€+X ãŒå³
            // æ–¹ä½è§’ï¼šNorth(0Â°) = -Zæ–¹å‘
            const x = distance * Math.sin(bearing * toRad);
            const z = -distance * Math.cos(bearing * toRad);
            const y = 0; // é«˜ã•ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åŒã˜ãƒ¬ãƒ™ãƒ«
            
            return { x, y, z };
        }

        // ========================================
        // UIæ›´æ–°ï¼šGPSæƒ…å ±ã¨ãƒ™ã‚¢ãƒªãƒ³ã‚°æƒ…å ±ã‚’è¡¨ç¤º
        // ========================================
        function updateUI() {
            if (!userLocation) return;

            const latEl = document.getElementById('user-lat');
            const lngEl = document.getElementById('user-lng');
            const headingEl = document.getElementById('device-heading');

            latEl.textContent = `ç·¯åº¦: ${userLocation.latitude.toFixed(6)}`;
            lngEl.textContent = `çµŒåº¦: ${userLocation.longitude.toFixed(6)}`;
            headingEl.textContent = `ãƒ‡ãƒã‚¤ã‚¹æ–¹è§’: ${deviceHeading.toFixed(1)}Â°`;

            // å„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒ™ã‚¢ãƒªãƒ³ã‚°ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
            Object.entries(TARGETS).forEach(([key, target]) => {
                const bearing = calculateBearing(
                    userLocation.latitude,
                    userLocation.longitude,
                    target.lat,
                    target.lng
                );
                const bearingEl = document.getElementById(`${key}-bearing`);
                if (bearingEl) {
                    bearingEl.textContent = `${target.name}: ${bearing.toFixed(1)}Â°`;
                }

                // æ–¹ä½è§’ã«åŸºã¥ã„ã¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä½ç½®ã‚’æ›´æ–°
                const pos = getLocalPositionFromBearing(bearing, target.distance);
                const entity = document.getElementById(target.entityId);
                if (entity) {
                    entity.setAttribute('position', `${pos.x.toFixed(2)} ${pos.y.toFixed(2)} ${pos.z.toFixed(2)}`);
                }
            });
        }

        // ========================================
        // GPSå–å¾—ï¼šä½ç½®æƒ…å ±ã‚’ç›£è¦–
        // ========================================
        function startGPS() {
            if (!navigator.geolocation) {
                alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
                return;
            }

            document.getElementById('gps-status').textContent = 'ä½ç½®æƒ…å ±å–å¾—ä¸­...';

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.watchPosition(
                (position) => {
                    userLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    document.getElementById('gps-status').textContent = `âœ“ å–å¾—æ¸ˆã¿ï¼ˆç²¾åº¦: Â±${position.coords.accuracy.toFixed(0)}mï¼‰`;
                    updateUI();
                },
                (error) => {
                    document.getElementById('gps-status').textContent = `âœ— ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                    console.error('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:', error);
                },
                options
            );
        }

        // ========================================
        // ãƒ‡ãƒã‚¤ã‚¹å‘ãå–å¾—ï¼šDeviceOrientation ã‚¤ãƒ™ãƒ³ãƒˆ
        // iOS 13+ã§ã¯äº‹å‰è¨±å¯ãŒå¿…è¦
        // ========================================
        function startDeviceOrientation() {
            if (!window.DeviceOrientationEvent) {
                alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ‡ãƒã‚¤ã‚¹å‘ãã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
                return;
            }

            // iOS 13+ï¼šè¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then((permission) => {
                        if (permission === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        }
                    })
                    .catch(console.error);
            } else {
                // ãã®ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function handleOrientation(event) {
            // alpha: Zè»¸å‘¨ã‚Šï¼ˆ0ã€œ360ï¼‰= ã‚³ãƒ³ãƒ‘ã‚¹æ–¹å‘
            deviceHeading = event.alpha || 0;
            updateUI();
        }

        // ========================================
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // ========================================
        document.getElementById('startBtn').addEventListener('click', () => {
            if (!userLocation) {
                alert('ä½ç½®æƒ…å ±ã‚’ã¾ãšå–å¾—ã—ã¦ãã ã•ã„');
                return;
            }
            arStarted = true;
            document.getElementById('startBtn').textContent = 'âœ“ AR å®Ÿè¡Œä¸­';
            document.getElementById('startBtn').disabled = true;
        });

        document.getElementById('permissionBtn').addEventListener('click', () => {
            startGPS();
            startDeviceOrientation();
        });

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        window.addEventListener('load', () => {
            console.log('AR ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•');
        });
    </script>
</body>
</html>