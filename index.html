<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Location-Based AR with A-Frame & AR.js</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimal-ui">
    <style>
        /* 許可ボタンを中央に配置するための基本的なスタイル */
        #ar-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            font-size: 1.2em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            cursor: pointer;
            display: block; /* 初期表示 */
        }
        #ar-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 1000;
        }
    </style>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
</head>
<body>

    <div id="ar-status">ステータス: 初期化中...</div>

    <button id="ar-button" onclick="requestDeviceOrientationAndStartAR()">Start AR & Location</button>

    <a-scene 
        vr-mode-ui="enabled: false" 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false;"
    >
        <a-camera gps-camera rotation-reader></a-camera>

        </a-scene>

    <script>
        // =======================================================================
        // 4. 定数定義
        // =======================================================================
        const AR_SCENE = document.querySelector('a-scene');
        const AR_STATUS = document.getElementById('ar-status');
        const AR_BUTTON = document.getElementById('ar-button');

        // 3Dモデルを配置する、カメラからの仮想的な距離（メートル）
        const VIRTUAL_DISTANCE_M = 8; 

        // ターゲット座標とモデル情報
        const TARGETS = [
            {
                name: 'Mt. Fuji (富士山)',
                modelPath: './assets/fuji.glb', // 富士山のglbモデルパス
                lat: 35.3606,
                lng: 138.7274,
                scale: '0.5 0.5 0.5', 
                offsetX: -1 // << 修正: 左に1メートルずらす
            },
            {
                name: 'Ranjatai (蘭奢待 - 正倉院)',
                modelPath: './assets/ra.glb', // 蘭奢待のglbモデルパス
                lat: 34.6851,
                lng: 135.8398,
                scale: '0.5 0.5 0.5',
                offsetX: 1 // << 修正: 右に1メートルずらす
            }
        ];

        let currentLocation = null; // ユーザーの現在地

        // =======================================================================
        // 5. 座標計算ロジック
        // =======================================================================

        /**
         * 2つのGPS座標から方位角（Bearing）を計算する（Haversineの派生）
         */
        function calculateBearing(lat1, lng1, lat2, lng2) {
            // 度をラジアンに変換
            const R_lat1 = lat1 * Math.PI / 180;
            const R_lat2 = lat2 * Math.PI / 180;
            const R_dLng = (lng2 - lng1) * Math.PI / 180;

            const y = Math.sin(R_dLng) * Math.cos(R_lat2);
            const x = Math.cos(R_lat1) * Math.sin(R_lat2) -
                      Math.sin(R_lat1) * Math.cos(R_lat2) * Math.cos(R_dLng);

            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            bearing = (bearing + 360) % 360;

            return bearing;
        }

        /**
         * 方位角と仮想距離から、A-Frameのローカル座標(x, y, z)を計算する
         */
        function bearingToLocalPosition(bearing, distance) {
            // 角度をラジアンに変換（Z軸負方向=前方、X軸正方向=右、Y軸正方向=上）
            const angleRad = (90 - bearing) * Math.PI / 180;
            
            const x = distance * Math.cos(angleRad);
            const z = distance * Math.sin(angleRad);
            
            return {
                x: x,
                y: 0,
                z: -z // Z軸の負の方向が前方に来るように
            };
        }


        // =======================================================================
        // 6. 初期化とモデル配置
        // =======================================================================

        /**
         * 現在地を取得し、ARエンティティを配置する
         */
        function setupAREntities() {
            if (!currentLocation) {
                AR_STATUS.textContent = "ステータス: GPSデータなし。ARエンティティを配置できません。";
                return;
            }

            AR_STATUS.textContent = "ステータス: ARオブジェクト配置中...";

            TARGETS.forEach(target => {
                // 1. 現在地からターゲットへの方位角を計算
                const bearing = calculateBearing(
                    currentLocation.latitude, currentLocation.longitude,
                    target.lat, target.lng
                );

                // 2. 方位角と仮想距離からローカル座標を計算
                let localPos = bearingToLocalPosition(bearing, VIRTUAL_DISTANCE_M);
                
                // 3. ローカルX軸に横方向のオフセットを適用（ARカメラの真横にずらす）
                // ただし、単に localPos.x に足すのではなく、オブジェクトの回転後のローカルX軸にオフセットを適用する必要がある。
                // 今回は、各エンティティを親要素とし、その子要素にモデルを配置し、親を回転させることで、ローカル座標の概念を単純化します。
                
                // AR.jsのLocation-Based ARでは、ターゲットを配置するエンティティ（親）を配置角度に合わせる
                const parentEntity = document.createElement('a-entity');
                
                // AR.jsが計算した方位角をそのままY軸の回転として適用する
                // AR.jsは真北0度をカメラのZ軸負方向（前）に合わせてくれるため、エンティティのY軸回転をbearingに設定
                parentEntity.setAttribute('rotation', `0 ${bearing} 0`);
                
                // 親エンティティをカメラの原点（0, 0, 0）に配置
                parentEntity.setAttribute('position', '0 0 0');


                // 4. モデルエンティティ（子）を作成し、親エンティティの子として追加
                const modelEntity = document.createElement('a-entity');

                // Z軸は仮想距離、X軸はオフセット（Y軸回転後のローカル座標）
                const modelPosString = `${target.offsetX} 0 ${-VIRTUAL_DISTANCE_M}`; 
                
                // 3Dモデルを読み込むための設定
                modelEntity.setAttribute('gltf-model', `url(${target.modelPath})`);
                
                // 仮想的なローカル座標を設定（Z軸方向に距離、X軸方向にオフセット）
                modelEntity.setAttribute('position', modelPosString);
                
                // スケールを適用
                modelEntity.setAttribute('scale', target.scale); 
                
                // 親エンティティに追加
                parentEntity.appendChild(modelEntity);

                
                // 5. テキストエンティティ（子）を作成し、親エンティティの子として追加
                const textEntity = document.createElement('a-entity');
                textEntity.setAttribute('text', {
                    value: target.name + `\nBearing: ${bearing.toFixed(0)}°`,
                    align: 'center',
                    color: '#FFF',
                    wrapCount: 30,
                    width: 4
                });
                // モデルの上、かつオフセット位置に配置
                textEntity.setAttribute('position', `${target.offsetX} 3 ${-VIRTUAL_DISTANCE_M}`); 
                // テキストは常にカメラの方を向くように設定（parentEntityは回転しているため、look-atで相対的な調整が必要）
                textEntity.setAttribute('look-at', '[gps-camera]'); 

                parentEntity.appendChild(textEntity);

                // シーンに追加
                AR_SCENE.appendChild(parentEntity);
            });

            AR_STATUS.textContent = "ステータス: AR準備完了";
        }

        // =======================================================================
        // 7. DeviceOrientation & GPS 許可リクエスト
        // =======================================================================

        /**
         * DeviceOrientationイベントの許可をリクエスト（iOS 13+対応）し、
         * その後、GPSを取得してARを開始する。
         */
        function requestDeviceOrientationAndStartAR() {
            AR_BUTTON.style.display = 'none';
            AR_STATUS.textContent = "ステータス: 許可リクエスト中...";

            const startGeolocation = () => {
                // GPSの取得
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        AR_STATUS.textContent = `ステータス: GPS取得完了 (Lat: ${currentLocation.latitude.toFixed(4)}, Lng: ${currentLocation.longitude.toFixed(4)})`;
                        setupAREntities();
                    },
                    (err) => {
                        AR_STATUS.textContent = `エラー: GPSが取得できませんでした (Code: ${err.code}). 位置情報サービスをONにしてください。`;
                        console.error('Geolocation Error:', err);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 5000
                    }
                );
            };

            // DeviceOrientationEventの許可リクエスト
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            startGeolocation();
                        } else {
                            AR_STATUS.textContent = "エラー: デバイスの向き（ジャイロ）の許可が必要です。ページをリロードして再度許可してください。";
                            console.error('Device Orientation Permission Denied');
                        }
                    })
                    .catch(error => {
                        AR_STATUS.textContent = "エラー: DeviceOrientationの許可リクエストに失敗しました。";
                        console.error('requestPermission Error:', error);
                    });
            } else {
                // requestPermissionが利用できないブラウザ（Androidなど）
                startGeolocation();
            }
        }
    </script>

</body>
</html>